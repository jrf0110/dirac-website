<!DOCTYPE HTML>
<html>
  <head>
    <title>Dirac.js</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dirac.js - Postgres ORM Thing" />

    <link rel="stylesheet" href="/css/core.gen.css">
    <link rel="stylesheet" href="bower_components/prismjs/prism.css">
    <link rel="stylesheet" href="bower_components/prismjs/prism-twilight.css">

    <script src="bower_components/requirejs/require.js"></script>
    <script src="js/require.config.js"></script>
    <script>
      require( ['js/home'], function( app ){
        app.init();
      });
    </script>
  </head>
  <body class="page-home">
    <!--<Navbar>-->
    <header class="navbar collapsed">
      <div class="container">
        <a href="/">
          <span class="navbar-logo">Dirac.js</span>
        </a>

        <ul class="nav">
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#examples">Examples</a></li>
          <li><a href="#middleware">Middleware</a></li>
          <li><a href="http://github.com/jrf0110/dirac">Github</a></li>
        </ul>
      </div>
    </header>
    <!--</Navbar>-->

    <div class="hero-unit">
      <h1>Postgres ORM Thing</h1>
      <p>For your node-pg interfacin'</p>
      <a href="#documentation" class="btn btn-large btn-tertiary btn-call-to-action">Skip to Documentation</a>
    </div>

    <section class="page-section" id="intro-section">
      <div class="container">
        <div id="intro-text">
          <h2 style="section-header">Easier Node Postgres</h2>
          <p>Paul Dirac was a theoretical physicist who made fundamental contributions to the early development of both quantum mechanics and quantum electrodynamics.
          </p>
          <p><em>Dirac.js</em> is an extendable and configurable database layer built on top of <a href="http://github.com/goodybag/mongo-sql">MoSQL</a> and made for Node Postgres. It has a pluginable architecture and ships with sensible middleware so you can avoid repetitive tasks.</p>
        </div>
        <div id="intro-code">
          <div class="window-pane">
            <div class="window-header">
              <i class="window-btn"></i>
              <i class="window-btn"></i>
              <i class="window-btn"></i>

              <div class="window-nav">
                <button class="btn btn-blank btn-prev">
                  <i class="fa fa-arrow-circle-o-left"></i>
                </button>

                <button class="btn btn-blank btn-next">
                  <i class="fa fa-arrow-circle-o-right"></i>
                </button>
              </div>
            </div>
            <div class="window-content">
<code class="language-javascript">var dirac = require('dirac');

// Register a table with dirac
dirac.register({
  name: 'users'
, schema: {
    id:         { type: 'serial', primaryKey: true }
  , email:      { type: 'text', unique: true }
  , createdAt:  { type: 'timestamp', default: 'now()' }
  }
});

// Connect to database
dirac.init({ database: 'my_app' });

// Perform non-destructive database sync
dirac.sync();

dirac.dals.users.findOne( 7, function( error, user ){
  /* ... */
});</code>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="page-section section-darker" id="marketing-points-section">
      <div class="container">
        <div class="marketing-points">
          <a href="#" class="point">
            <i class="point-icon fa fa-refresh"></i>
            <h3 class="point-title">Destructive or non-destructive database syncing</h3>
          </a>
          <a href="#" class="point">
            <i class="point-icon fa fa-table"></i>
            <h3 class="point-title">JSON table and view definitions</h3>
          </a>
          <a href="#" class="point">
            <i class="point-icon fa fa-anchor"></i>
            <h3 class="point-title">Standard CRUD</h3>
          </a>
          <a href="#" class="point">
            <i class="point-icon fa fa-code"></i>
            <h3 class="point-title">Robust JSON queries</h3>
          </a>
          <a href="#" class="point">
            <i class="point-icon fa fa-plus"></i>
            <h3 class="point-title">Pluginable Architecture</h3>
          </a>
        </div>
      </div>
    </section>

    <section class="page-section" id="documentation">
      <div class="container">
        <h2 class="section-title">Documentation</h2>

        <div class="docs-nav-col">
          <ul class="nav nav-vertical" id="docs-nav">
            <li><a href="#docs-getting-started">Getting Started</a></li>
            <li>
              <a href="#docs-root-api">Root API</a>
              <ul class="nav nav-vertical">
                <li><a href="#">dirac.init</a></li>
                <li><a href="#">dirac.query</a></li>
                <li><a href="#">dirac.raw</a></li>
                <li><a href="#">dirac.register</a></li>
                <li><a href="#">dirac.dropAllTables</a></li>
                <li><a href="#">dirac.sync</a></li>
                <li><a href="#">dirac.use</a></li>
                <li><a href="#">dirac.createTable</a></li>
                <li><a href="#">dirac.saveCurrentDbState</a></li>
              </ul>
            </li>
            <li>
              <a href="#docs-dal">DAL</a>
              <ul class="nav nav-vertical">
                <li><a href="#">dirac.dals.table_name.find</a></li>
                <li><a href="#">dirac.dals.table_name.findOne</a></li>
                <li><a href="#">dirac.dals.table_name.remove</a></li>
                <li><a href="#">dirac.dals.table_name.update</a></li>
                <li><a href="#">dirac.dals.table_name.insert</a></li>
                <li><a href="#">dirac.dals.table_name.before</a></li>
                <li><a href="#">dirac.dals.table_name.after</a></li>
              </ul>
            </li>
            <li>
              <a href="#docs-database-syncing">Database Syncing</a>
              <ul class="nav nav-vertical">
                <li><a href="#">Alter Table Strategies</a></li>
                <li><a href="#">dirac.strategies.has</a></li>
                <li><a href="#">dirac.strategies.get</a></li>
                <li><a href="#">dirac.strategies.register</a></li>
              </ul>
            </li>
          </ul>
        </div>

        <div class="docs-content-col">
          <section class="docs-section" id="docs-getting-started">
            <h3 class="section-title">Getting Started</h3>
            <p>Dirac.js is meant to be a solid starting point for your main database module. While you could have all of your logic in a single file, I like to group code by table as seen in the file structure below:</p>
            <h4>File Structure</h4>
<pre>
  - lib/
  - db/
    - tables/
        - groups.js
        - users.js
        - users_groups.js
    - index.js
  - app.js
</pre>
            <h4>Your Main Database Module</h4>
            <div class="window-pane">
              <div class="window-header">
                <i class="window-btn"></i>
                <i class="window-btn"></i>
                <i class="window-btn"></i>
                <h5 class="window-name">db/index.js</h5>
              </div>
              <div class="window-content">
<code class="language-javascript">var fs      = require('fs');
var path    = require('path');
var dirac   = require('dirac');
var config  = require('../config');

// Specify the `tables` directory
var dir = path.join( __dirname, 'tables' );

// Register each table file with dirac
fs.readdirSync( dir ).filter( function( file ){
  return fs.statSync( path.join( dir, file ) ).isFile();
}).map( function( t ){
  return require( path.join( dir, t ) );
}).forEach( dirac.register );

// Set the DB Config
dirac.init( config.db );

// Export the dals namespace for easy access
module.exports = dirac.dals;
</code>
              </div>
            </div>

            <p>The `dirac.dals` namespace is where each table interface is. So in the example above, groups, users, and users_groups would be available under `dirac.dals`.</p>

            <h4>Using the Database Module</h4>
            <div class="window-pane">
              <div class="window-header">
                <i class="window-btn"></i>
                <i class="window-btn"></i>
                <i class="window-btn"></i>
                <h5 class="window-name">app.js</h5>
              </div>
              <div class="window-content">
<code class="language-javascript">var db = require('./db');

// Get the Database up-to-date with current schema
db.sync();

// Query where clause
// See https://github.com/goodybag/mongo-sql/blob/master/docs/conditional-helpers.md
// For all where clause options
var $where = {
  created_at: { $gt: new Date('2012-01-01') }
};

// Other query options
// See https://github.com/goodybag/mongo-sql/blob/master/docs/query-types.md#type-select
// for full options
var options = {
  order: { id: 'desc' }
, limit: 10
};

// Find all users created after specified date
// order by id desc and limit 10
db.users.find( $where, options, function( error, users ){
  if ( error ) process.exit(1);

  console.log( "Users:", users );
  process.exit(0);
});
</code>
              </div>
            </div>
          </section>

          <section class="docs-section" id="docs-root-api">
            <h3 class="section-title">Root API</h3>
            <p>The dirac is split up into two main API's: The root API and the DAL (Data Access Layer) API. The root API involves any non-table-specific functionality while the DAL API is table-specific.</p>

            <h4 class="docs-method" id="docs-root-init">dirac.init( options )</h4>
            <p class="docs-method-description">Connect to Postgres</p>
            <h5>Arguments</h5>
            <ul class="docs-parameters">
              <li>@param {Object} Options</li>
              <ul>
                <li>@property `connStr`</li>
                <li>@property `port` default: 5432</li>
                <li>@property `host` default: 'localhost'</li>
                <li>@property `database`</li>
              </ul>
            </ul>

            <h4 class="docs-method" id="docs-root-init">dirac.query( queryObject, callback )</h4>
            <p class="docs-method-description">Execute a <a href="http://github.com/goodybag/mongo-sql">MoSQL</a> query</p>
            <h5>Arguments</h5>
            <ul class="docs-parameters">
              <li>
                @param {Object} queryObject
                <br />
                See the <a href="https://github.com/goodybag/mongo-sql/tree/master/docs">MoSQL query documentation</a>
              </li>
              <li>@param {Function} callback( error, results )</li>
            </ul>
            <div class="window-pane">
              <div class="window-header">
                <i class="window-btn"></i>
                <i class="window-btn"></i>
                <i class="window-btn"></i>
                <h5 class="window-name">dirac.query</h5>
              </div>
              <div class="window-content">
<code class="language-javascript">var dirac = require('/dirac');

var $query = {
  type: 'select'
, table: 'users'
, columns: [ 'id', 'name' ]
, where: {
    id: {
      $in: [ 1, 2, 3, 4 ]
    }
  }
};

dirac.query( $query, function( error, users ){
  /* ... */
});
</code>
              </div>
            </div>

            <h4 class="docs-method" id="docs-root-init">dirac.raw( sql, values, callback )</h4>
            <p class="docs-method-description">Execute a SQL query</p>
            <h5>Arguments</h5>
            <ul class="docs-parameters">
              <li>@param {String} sql - SQL string</li>
              <li>@param {Array}  values - SQL values</li>
              <li>@param {Function} callback( error, results )</li>
            </ul>
            <div class="window-pane">
              <div class="window-header">
                <i class="window-btn"></i>
                <i class="window-btn"></i>
                <i class="window-btn"></i>
                <h5 class="window-name">dirac.raw</h5>
              </div>
              <div class="window-content">
<code class="language-javascript">var dirac = require('/dirac');

var sql = 'select * from users where id = $1';
var values = [ 50 ];

dirac.raw( sql, values, function( error, users ){
  /* ... */
});
</code>
              </div>
            </div>

            <h4 class="docs-method" id="docs-root-init">dirac.register( callback )</h4>
            <p class="docs-method-description">Registers a new table or view with dirac. Will not actually create the table until dirac.sync() is called. Alternatively, you could call: dirac.dals.table_name.createIfNotExists() to manually add it. However, sync will resolve table dependencies and it will also save the database state so dirac can reason about your current table structure.</p>
            <h5>Arguments</h5>
            <ul class="docs-parameters">
              <li>@param {Object} table definition - Required Properties:</li>
              <ul class="docs-parameters">
                <li>@property {String} name - Name of the table</li>
                <li>@property {Object} schema - Schema of table (see <a href="https://github.com/goodybag/mongo-sql/blob/master/docs/query-helpers.md#helper-definition">MoSQL definition helper</a>)</li>
              </ul>
            </ul>
            <div class="window-pane">
              <div class="window-header">
                <i class="window-btn"></i>
                <i class="window-btn"></i>
                <i class="window-btn"></i>
                <h5 class="window-name">dirac.register</h5>
              </div>
              <div class="window-content">
<code class="language-javascript">var dirac = require('/dirac');

// Register table
dirac.register({
  name: 'users'
, schema: {
    id: {
      type: 'serial'
    , primaryKey: true
    }
  , name: { type: 'text' }
  }
});

// Register View
dirac.register({
  name: 'bobs'
, type: 'view'
, query: {
    type: 'select'
  , table: 'users'
  , where: { name: { $ilike: 'bob' } }
  }
});

dirac.init(/* ... */);

dirac.dals.users.findOne( 7, function( error, user ){ /* ... */ });
</code>
              </div>
            </div>

            <h4 class="docs-method" id="docs-root-init">dirac.dropAllTables( callback )</h4>
            <p class="docs-method-description">Run the command for dropping all registered tables.</p>
            <h5>Arguments</h5>
            <ul class="docs-parameters">
              <li>@param {Function} callback( error, results )</li>
            </ul>

            <h4 class="docs-method" id="docs-root-init">dirac.sync( [options], [callback] )</h4>
            <p class="docs-method-description">Get Database up-to-date with latest schemas</p>
            <h5>Arguments</h5>
            <ul class="docs-parameters">
              <li>
                @param {Object} options - Options for sync
                <ul class="docs-parameters">
                  <li>@property {Boolean} force - If `true` will perform destructive sync</li>
                </ul>
              </li>
              <li>@param {Function} callback( error )</li>
            </ul>

            <h4 class="docs-method" id="docs-root-init">dirac.use( middleware )</h4>
            <p class="docs-method-description">Pass a function to dirac to be called whenever `dirac.init` is called. Useful for initializing before/after filters and adding database-wide properties to all schemas.</p>
            <h5>Arguments</h5>
            <ul class="docs-parameters">
              <li>@param {Function} middleware( dirac ) - - the function that will be called when dirac is initialized. It's passed a single parameter (the dirac module).</li>
            </ul>
            <div class="window-pane">
              <div class="window-header">
                <i class="window-btn"></i>
                <i class="window-btn"></i>
                <i class="window-btn"></i>
                <h5 class="window-name">db/middleware/created-at.js</h5>
              </div>
              <div class="window-content">
<code class="language-javascript">/**
 * Automatically adds created_at/updated_at fields to schemas
 */
var dirac = require('/dirac');

var utils = require('utils');

module.exports = function( options ){
  utils.defaults( options, {
    createdAt: {
      name: 'created_at'
    , type: 'timestamp'
    , default: 'now()'
    }
  , updatedAt: {
      name: 'updated_at'
    , type: 'timestamp'
    , default: 'now()'
    }
  });

  return function( dirac ){
    // Adds fields to a DAL
    var addFields = function( dal ){
      var schema = dirac.dals[ dal ].schema;

      // Add createdAt if it's not already there
      if ( !(options.createdAt.name in schema) ){
        schema[ options.createdAt.name ] = options.createdAt;
      }

      // Add updatedAt if it's not already there
      if ( !(options.updatedAt.name in schema) ){
        schema[ options.updatedAt.name ] = options.updatedAt;
      }
    };

    // Before filter adds updatedAt = 'now()' to the update query
    var updateFilter = function( $query, schema, next ){
      // Updates may be on values or updates
      var values = 'values' in $query ? $query.values : $query.updates;

      values[ options.updatedAt.name ] = 'now()';

      next();
    };

    // Registers before filters to update updatedAt
    var addFilters = function( dal ){
      dirac.dals[ dal ].before( 'update', updateFilter );
    };

    // Add fields to each DAL
    Object.keys( dirac.dals ).forEach( addFields )

    // Add filters to each DAL
    Object.keys( dirac.dals ).forEach( addFilters )
  };
};
</code>
              </div>
            </div>
            <div class="window-pane">
              <div class="window-header">
                <i class="window-btn"></i>
                <i class="window-btn"></i>
                <i class="window-btn"></i>
                <h5 class="window-name">db/index.js</h5>
              </div>
              <div class="window-content">
<code class="language-javascript">/**
 * Register our database middleware
 */
var dirac = require('/dirac');

var middleware = {
  createdAt: require('./middleware/created-at')
};

dirac.use(
  middleware.createdAt({
    updatedAt: {
      name: 'last_updated'
    , type: 'timestamp'
    , default: 'now()'
    }
  })
);

// DAL registration
// ...
// ...

// After init is called, all functions specified in use are called
dirac.init( config.db );
</code>
              </div>
            </div>

            <h4 class="docs-method" id="docs-root-saveCurrentDbState">dirac.saveCurrentDbState( version, [callback] )</h4>
            <p class="docs-method-description">Save an entry in the dirac_schemas table of the current DAL state in memory. This happens everytime you call `sync`</p>
            <h5>Arguments</h5>
            <ul class="docs-parameters">
              <li>
                @param {Object} options - Options for sync
                <ul class="docs-parameters">
                  <li>@property {Boolean} force - If `true` will perform destructive sync</li>
                </ul>
              </li>
              <li>@param {Function} callback( error )</li>
            </ul>
          </section>
        </div>
      </div>
    </section>

    <section class="page-section section-primary">
      <div class="container">
        <h2 class="section-header">Another Section</h2>
      </div>
    </section>

    <div class="filler"></div>

    <!--<Footer>-->
    <footer class="footer">
      <div class="container">
        <span class="footer-logo">Dirac.js</span>
        
        <ul class="nav">
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#examples">Examples</a></li>
          <li><a href="#middleware">Middleware</a></li>
          <li><a href="http://github.com/jrf0110/dirac">Github</a></li>
        </ul>
        <div class="copyright">Dirac.js is awesome and you should use it</div>
      </div>
    </footer>
    <!--</Footer>-->
  </body>
</html>
